BlenderImageLUT
---
Real time image-based color grading in Blender's compositor.
# WARNING
Only LDR sRGB LUTs are supported. There is NO correctness guarantee for this implementation and is currently *NOT* color correct. Use at your own risk.

# Usage
## Loading the Nodes
- [Download `BlenderImageLut.blend`](https://github.com/mos9527/blender-image-lut/raw/refs/heads/main/BlenderImageLUT.blend)
- In your Blender project, Go to `File > Append...`
<img width="318" alt="image" src="https://github.com/user-attachments/assets/346d0ecb-cd1c-4a60-a09c-413434504b72" />

- Open the downloaded `.blend` file and go to `NodeTree`, where you can find the node **`BlenderImageLUT`**. Click `Append`
<img width="560" alt="image" src="https://github.com/user-attachments/assets/c29c85e4-f952-4b3a-8ec5-d2fae1e550e2" />

- In the `Compositor` tab, enable `Use Nodes` and search for `BlenderImageLUT` with F3, add it to your node tree
<img width="764" alt="image" src="https://github.com/user-attachments/assets/e0e06b70-0f8b-4a27-a099-650cf651a656" />

## Loading the LUT image
- Add an `Image` node with F3 and then load the LUT image of your choice **and setup the `LUT Dimension` ($D$) properly**.
  - **ATTENTION:** Please refer to the [Notes](#notes) section for what kind of LUT image you should be using.
- Ensure your image transform is linear. Again, **read the [Notes](#notes) section** for more information.
- Connect the nodes. Your final node setup should look like this:
<img width="482" alt="image" src="https://github.com/user-attachments/assets/f39275a0-2aae-47db-a00a-e1f5e81f25af" />

- To view the result, you can enable the compositor under the `Viewport Shading` tab and set the compositor option to `Always` as shown below
<img width="830" alt="image" src="https://github.com/user-attachments/assets/64372a9d-807b-4db1-81de-ee169c2ae472" />

# Notes
## LUT Dimension
Your 3D LUT transform should be a **2D Image** of pixel dimension $(D^2,D)$, where $$D$$ is the **uniform size in pixel of your LUT**

The 3D texture should be swizzled onto the 2D plane like this:
```
Numbers indicate the index of the Z-slice
 ┌───────┬───────┬───────┬─────┐ 
 │       │       │       │     │ 
 │   1   │   2   │   3   │ ..n │ 
 │       │       │       │     │ 
 └───────┴───────┴───────┴─────┘
```
For example, here's a *netural* one with $D=16$, Generated by [lutgen.py](https://github.com/mos9527/BlenderImageLUT/blob/main/lutgen.py)

![image](https://github.com/user-attachments/assets/60dac6c8-bfb6-45dd-8017-da5003cbc777)

The $R,G,B$ channels should advance in value in the UV (pixel) direction shown in the following diagrams:
- $R$ channel
<img width="512" alt="image" src="https://github.com/user-attachments/assets/4009e5f4-3eac-43d2-ad2e-4f029ad79669" />

- $G$ channel
<img width="512" alt="image" src="https://github.com/user-attachments/assets/7595ebe0-17a7-49a3-b206-e5a399d93e98" />

- $B$ channel
<img width="512" alt="image" src="https://github.com/user-attachments/assets/4aecd6e1-e3e6-44d9-9ceb-98f5de5c2504" />

## Colorspace (with sRGB LUTs)
LUTs **MUST** **contain mapping from Linear (pixel coords) to Linear (colors)** since Blender's compositor uses linear colorspace at all times

[With PNG in sRGB colorspace, the transfer function is simply a power function with gamma 2.2](http://www.libpng.org/pub/png/spec/1.2/png-1.2-pdg.html#C.Anc-color). The following node setup converts the transformed (sRGB->Linear) colors back to sRGB (encoded, linear in UV) colors
<img width="1387" alt="image" src="https://github.com/user-attachments/assets/557711c8-09c8-456b-85c4-6e9166cb6111" />

Another setup like this also works, which skips color conversions and uses the sample as is
<img width="1230" alt="image" src="https://github.com/user-attachments/assets/111e8285-f510-4271-93a5-90e96853fadb" />

## Transposing LUTs of different dimensions
(todo)

# How it works
By implementing Bilinear Filtering and 3D texture sampling from scratch with Compositor Nodes and performs LERPed color look-up in runtime.

Generally there will be 8 texture lookups for each pixel - which is expensive. Use this node setup sparingly or only at render-time!

# References
- Real Time Rendering 4th Edition
- https://github.com/mos9527/sssekai_blender_io
- https://docs.blender.org/manual/en/latest/render/color_management.html
